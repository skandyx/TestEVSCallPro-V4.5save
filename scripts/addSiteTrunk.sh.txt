#!/bin/bash
# ==============================================================================
# Script d'Ajout de Trunk SIP pour un Site Yeastar
# ==============================================================================
# CE SCRIPT DOIT ÊTRE EXÉCUTÉ AVEC LES PRIVILÈGES SUDO.
#
# Ce script ajoute la configuration PJSIP nécessaire dans Asterisk pour
# se connecter à un PBX Yeastar d'un site distant.
#
# USAGE: sudo ./scripts/addSiteTrunk.sh <ID_du_Site> <IP_VPN_du_Yeastar>
#
# Exemple: sudo ./scripts/addSiteTrunk.sh 1 10.1.0.254
# ==============================================================================

set -e # Arrête le script si une commande échoue

# --- Variables ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

PJSIP_TRUNKS_FILE="/etc/asterisk/pjsip_custom.conf"

# --- Fonctions ---
info() {
    echo -e "${YELLOW}INFO:${NC} $1"
}

success() {
    echo -e "${GREEN}SUCCESS:${NC} $1"
}

error() {
    echo -e "${RED}ERROR:${NC} $1" >&2
}

# --- Vérification des privilèges ---
if [ "$EUID" -ne 0 ]; then
  error "Ce script doit être exécuté avec les privilèges root (sudo)."
  exit 1
fi

# --- Vérification des arguments ---
if [ "$#" -ne 2 ]; then
    error "Nombre d'arguments incorrect."
    echo "USAGE: sudo $0 <ID_du_Site> <IP_VPN_du_Yeastar>"
    echo "Exemple: sudo $0 1 10.1.0.254"
    exit 1
fi

SITE_ID=$1
YEASTAR_IP=$2
TRUNK_NAME="trunk-site${SITE_ID}"

info "Vérification de l'existence du trunk '${TRUNK_NAME}'..."

# --- Vérification de l'existence ---
if grep -q "\[${TRUNK_NAME}\]" "$PJSIP_TRUNKS_FILE"; then
    error "Un trunk avec le nom '${TRUNK_NAME}' existe déjà dans ${PJSIP_TRUNKS_FILE}."
    exit 1
fi

success "Le trunk n'existe pas, création en cours..."

# --- Ajout de la configuration ---
# Utilise un bloc "here document" pour ajouter la configuration PJSIP complète
# à la fin du fichier des trunks.
cat << EOF >> "$PJSIP_TRUNKS_FILE"

; --- Trunk pour Site ${SITE_ID} (${YEASTAR_IP}) ---
[${TRUNK_NAME}]
type=endpoint
context=from-yeastar
disallow=all
allow=ulaw,alaw
aors=${TRUNK_NAME}
identify_by=ip

[${TRUNK_NAME}]
type=aor
contact=sip:${YEASTAR_IP}:5060

[${TRUNK_NAME}]
type=identify
endpoint=${TRUNK_NAME}
match=${YEASTAR_IP}
EOF

success "Configuration pour le trunk '${TRUNK_NAME}' ajoutée à ${PJSIP_TRUNKS_FILE}."

# --- Rechargement PJSIP ---
info "Rechargement du module PJSIP d'Asterisk..."
asterisk -rx "pjsip reload"
success "Module PJSIP rechargé."

echo -e "\n${GREEN}Le trunk pour le site ${SITE_ID} a été configuré avec succès !${NC}"
